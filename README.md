# Домашнее задание №2 (основы работы с kubernetes)

В корне проекта лежит nginx-ingress.yaml, который использовался для установки контроллера, дабы не потерять.

В директории hw_manifests находятся манифесты для выполнения ДЗ.

## Deployment.yml
Описывает ресурс деплоймента. После его применения будет создано 3 пода, в каждом из которых будет развернуто по
1-му контейнеру из образа ana1oliy/otus.hw:1, указанного в параметре `spec.template.spec.containers.name`. Имена
подов будут иметь префикс `hw2-deployment`, что определяется параметром `spec.template.spec.containers.name`.
Каждый контейнер будет слушать порт 8000.

Количество подов будет поддерживаться kubrrnetes в количестве трех экземпляров. Так как страдегия обновления не
указана, по умолчанию будет использоваться `RollingUpdate`.

Контрольа подов происходит по меткам `app: hw2-health`.

## Service.yml
Описывает ресурс сервиса, который бужет обеспечивать доступ к определенным контейнерам. Поды, на которых развернуты
контейнеры выбираются по метке `app: hw2-health`. В параметре `spec.ports` задаются порты, с которыми будет работать
сервис. Если я правильно понял документацию, в нашем примере мы указываем, что для протокола `TCP` траффик пришедший
на порт (`port`) `8000` сервиса внутри внутри кластера, а так же на случайный порт (`nodePort`) снаружи кастера,
будет перенаправлен на порт `hw2-health-port` подов. Порт `hw2-health-port` это именованый порт и он имеет значение
`8000`. Можно явно определить порт `nodePort`, но этого делать не рекомендуется. Его значение должно быть между
`30000` и `32767`.

## Ingress.yml
Описывает ресурс ингресса. Ингресс перенаправляет пришедший из вне кластера траффик по поределенным првилам на
сервисы.

В даном случае весь траффик пришедший на хост `arch.homework` на корневой путь будет перенаправлен на порт `8000`
сервиса `hw2-service`.

## Ingress_x.yml
Так же описывает ресурс ингресса, но он перенаправляет траффик пришедший на хост по пути `/otusapp/miller/*` на порт
`8000` сервиса `hw2-service`.

## Применение настроек
Описанные параметры применяются командой
```bash
kubectl apply -f ./hw_manifests/
```
если мы находимся в директории проекта.

## Проверка
Проверить всё ли правильно работает можно следующим образом.

Если в `/etc/hosts` прописан `arch.homework`, то
```bash
curl arch.homework/health/
```
```bash
curl arch.homework/otusapp/miller/health/
```
В противном случае сетим в переменную ip кубика
```bash
OTUS_HW_MINIKUBE_IP=(`minikube ip`)
```
и проверяем
```bash
curl -H 'Host: arch.homework' http://$OTUS_HW_MINIKUBE_IP/health/
```
```bash
curl -H 'Host: arch.homework' http://$OTUS_HW_MINIKUBE_IP/otusapp/miller/health/
```

Кроме прочего дожен быть доступ к `/health/` напрямую через сервис.
```bash
OTUS_HW_SERVICE_URL=(`minikube service hw2-service --url`)
curl $OTUS_HW_SERVICE_URL/health/
```

